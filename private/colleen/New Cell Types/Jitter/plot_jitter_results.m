%  %% 2016-02-17-6 data026_cf_split/edited/data026_cf_split
%     number = [1021 1022 1023 1027 1028 1741 1742 1743 1744 2751 2752 2753 3066 3067 3068 3466 3468 3469 3470 4296 4297 4298 4299 4300 4327 4328 4329 4330 4332 5026 5027 5028 5176 5177 5178 5179 5180 5536 5537 5538 5539] %ON parasol
%    %ON parasol
%     number = [2751 2752 2753, [nan], [nan];...
%                 3066 3067 3068, [nan], [nan];...
%                 3466 3468 3469 3470, [nan];...
%                 4296 4297 4298 4299 4300;...
%                 4327 4328 4329 4330 4332] 
% %OFF parasol
%  number = [1021 1022 1023 1027 1028;
%            1741 1742 1743 1744 nan;
%            5026 5027 5028 nan nan;
%            5176 5177 5178 5179 5180;
%            5536 5537 5538 5539 nan] 
%        
% %% 2016-04-21-8 data022-mVision/data022_422_4818/data022
%   cell_type = 'OFF smooth';  
%     number = [422 427 428 429;...
%         4818 4820 4826 4827;...
%         ] 
%        
       %% 2016-04-21-8 data022
       


%    number = [154 408 903 1953 3137 3259 3319;...
%         3721 3813 3861 4490 4565 4773 4778;...
%         5912 1711 3077 4337 4761 5888 3078;...
%         3381 4248 4653 5886 7507 7508 nan] %all
%   
%   cell_type = 'OFF smooth';  
%     number = [408 3137 3319;...
%         3721 3861 4773 ;...
%         4778 5912 nan;...
%         ] 
%     cell_type = 'OFF Type 2';  
%     number = [154 903 1953;...
%         3259 3813 4490;...
%         4565 nan nan;...
%         ] 
%       
%         cell_type = 'ON Smooth';  
%     number = [3077 ;...
%         4337 ;...
%         4761;...
% 
%         ] 
%         cell_type = 'ON Type 2';  
%     number = [1711 ;...
%         5888
%         ] 
%        
%             cell_type = 'Other';  
%     number = [3078 3381 4248;...
%             4653 5886 7507;...
%             7508 nan nan
%         ] 
%     
% 
%             cell_type = 'ON parasol';  
%     number = [526 527 528;...
%         901 902 903;...
%         1621 1622 1623;...
%         ]
%     

%% 2016-04-21-8 data022-cf
% number = [154 406 407 901 1953 3140 3259;...
%         3721 3813 4487 4565 4771 ;...
%         5912 1711 3077 4337 4761 3077;...
%         3381 4248 7501 nan] %all
  
%   cell_type = 'OFF smooth';  
%     number = [406 407 3140 ;...
%         3721  4771 5912 ;...
%         ] 
%     cell_type = 'OFF Type 2';  
%     number = [154 901 1953;...
%         3259 3813 4487;...
%         4565 nan nan;...
%         ] 
%       
%         cell_type = 'ON Smooth';  
%     number = [3077 4337 4761 ;...
%         ] 
%         cell_type = 'ON Type 2';  
%     number = [1711 ;...
%         
%         ] 
%        
%             cell_type = 'Other';  
%     number = [3078 3381 4248;...
%             7501 nan nan
%         ] 
%     
% 
%             cell_type = 'ON parasol';  
%     number = [526 527 528;...
%         901 902 903;...
%         1621 1622 1623;...
%         ]
  

%% 2016-04-21-8 data022-mVision/data022_recluster
% number = [154 406 407 901 1953 3140 3259;...
%         3721 3813 4487 4565 4771 ;...
%         5912 1711 3077 4337 4761 3077;...
%         3381 4248 7501 nan] %all
  
%   cell_type = 'OFF smooth';  
%     number = [422 427 428 429;...
%         4818 4820 4826 4827;...
%         ] 
%     cell_type = 'OFF Type 2';  
%     number = [154 901 1953;...
%         3259 3813 4487;...
%         4565 nan nan;...
%         ] 
%       
%         cell_type = 'ON Smooth';  
%     number = [3077 4337 4761 ;...
%         ] 
%         cell_type = 'ON Type 2';  
%     number = [1711 ;...
%         
%         ] 
%        
%             cell_type = 'Other';  
%     number = [3078 3381 4248;...
%             7501 nan nan
%         ] 
%     
% 
%             cell_type = 'ON parasol';  
%     number = [526 527 528;...
%         901 902 903;...
%         1621 1622 1623;...
%         ]


    %% 2015-09-23-7 data028
        
%   cell_type = 'OFF smooth';  
%     number = [305 412 1006 1007 1008;...
%         1876 2161 3498 3676 4651;...
%         4712 5341 5660 5941 5942;...
%         7043 nan nan nan nan
%          ] 
%     cell_type = 'OFF Type 2';  
%     number = [154 903 1953;...
%         3259 3813 4490;...
%         4565 nan nan;...
%         ] 
%       
%         cell_type = 'ON Smooth';  
%     number = [533 1027 1430 ;...
%         1568 2377 3171 ;...
%         4205 4715 5238 
%         ] 
%         cell_type = 'ON Type 2';  
%     number = [1711 ;...
%         5888
%         ] 
%        
%             cell_type = 'Other';  
%     number = [3078 3381 4248;...
%             4653 5886 7507;...
%             7508 nan nan
%         ] 
    
    
%% 2016-04-21-1 data006-cf
% 
%             cell_type = 'ON parasol';  
%     number = [526 527 528;...
%         901 902 903;...
%         1621 1622 1623;...
%         ];
    
%             cell_type = 'OFF parasol';  
%     number = [4592 4594 4595 nan nan;...
%         5191 5192 5193 5194 5195;...
%         5492 5493 5494 nan nan;...
% 
%         ]

%% 2016-02-17-1 data007-cf
% cell_type = 'ON large 2';
% number = 91;

% %% 2016-02-17-6 data024-cf
% cell_type = 'OFF Smooth';
% number = [3031 3442 3901;...
%     4893 4982 6526;...
%     7056 7473 nan];

%% 2016-02-17-6 data024-cf
cell_type = 'OFF Smooth';
number = [811;...
    ];

%%      
date = '2016-02-17-6/data026_cf/edited';
datarun = 'data026_cf';
% number = [154 408 903 1953 3137 3259 3319 3721 3813 3861 4490 4565 4773 4778 5912];

% number = [532 1022 1568 2376 3186 4041 4703 5239 6788 7101];
% number{2} = [185 306 413 996 1058 1759 1821 2061 3396 3593 3830 4656 5342 5733 6064 6213 7148];

% number = [532 1022 1568 2376 3186 4041 4703 5239 6788 7101];
%     number= []; %ON parasol

%number = [1936] %ON parasol

  % dataparam.cell_specification = [482 813 1537 2103 2167 3288 3694 3889 4326 4939 6336 6517];

  x_plots = size(number,1); % number of plots down
y_plots = size(number,2);

number = number';
sta = zeros(320,640);
figure;
%           for ii = 1:6; axes(ha(ii)); plot(randn(10,ii)); end
%           set(ha(1:4),'XTickLabel',''); set(ha,'YTickLabel','')



% y_plots = ceil(length(number)/x_plots);
ha = tight_subplot(x_plots, y_plots, [.01 .03],[.01 .01],[.01 .01]); % vertical horizontal

for i = 1:x_plots*y_plots
    if ~isnan(number(i))%i <= length(number(:))
%     hold on 
    load(['/Volumes/Lab/Users/crhoades/Jitter/', date, '/', datarun,'/Cell ', num2str(number(i)), '.mat'])
    if size(size(temp),2) == 3
    temp = permute(temp, [2,1,3]);
%     [sig_stixels] = significant_stixels(temp, 'select', 'thresh', 'thresh', 4.25);
    [~,start_index] = max(sum(reshape(temp.^2,[],size(temp,3)),1));

    temp = norm_image(temp);
    axes(ha(i));

    imagesc(temp(:,:,start_index));
    colormap(gray)
    
    else
        
         temp = permute(temp, [2,1,3,4]);
%     [sig_stixels] = significant_stixels(temp, 'select', 'thresh', 'thresh', 4.25);
    [~,start_index] = max(sum(reshape(temp.^2,[],size(temp,4)),1));

    temp = norm_image(temp);
    axes(ha(i));

    imagesc(temp(:,:,:,start_index));
    
    end
    
    axis image
    title(['Cell ', num2str(number(i))])
    axis off
    
%     sta((sig_stixels) == 1) = i;
%    sta = sta+ sig_stixels;

    else
            axes(ha(i));

        axis off
    end

 
        
    
end
datarun_mod = strrep(datarun, '_', '\_');

suptitle({[date, ' ', datarun_mod]; cell_type} )


figure; imagesc(sta(10:end-10, 10:end-10));

axis image
axis off


[~,git_hash_string] = system('git rev-parse HEAD');
fprintf('Git Hash: %s \n', git_hash_string);


%% Mosiac from Vision
dataparam.date='2016-02-17-6/data026_cf/edited';
dataparam.concatname='data026_cf';
dataparam.file_name = [dataparam.date, '/', dataparam.concatname,'/', dataparam.concatname];
select_cells = 1;
if select_cells == 1
dataparam.cell_specification = [437];
    
end
dataparam.cell_type = {'all'};

% Right Movie
datarun.names.rrs_neurons_path=['/Volumes/Analysis/', dataparam.file_name, '.neurons'];
datarun.names.rrs_params_path=['/Volumes/Analysis/', dataparam.file_name, '.params'];
datarun.names.rrs_sta_path = ['/Volumes/Analysis/', dataparam.file_name, '.sta'];

opt=struct('verbose',1,'load_params',1,'load_neurons',1,'load_obvius_sta_fits',true, 'load_sta', 1, 'load_sta_params', 1, 'load_all',true);
opt.load_sta_params.save_rf = 1;
% opt.load_sta_params.frames = 1:fitparam.num_frames;% have to input as a vector list of frames, not the number of frames total, counting backwards
datarun=load_data(datarun,opt);

cell_ids = get_cell_indices(datarun, dataparam.cell_specification)
clear sta
summary = zeros(size(double(datarun.stas.stas{cell_ids(1)}),1), size(double(datarun.stas.stas{cell_ids(1)}),2));

for i = 1:length(cell_ids)
sta = double(datarun.stas.stas{cell_ids(i)});

  [sig_stixels, params, rf_strength_out] = significant_stixels(sta, 'select', 'thresh', 'thresh', 4);

    summary = summary+ sig_stixels;

end
    figure; imagesc(summary);
    axis image
    
    [~,git_hash_string] = system('git rev-parse HEAD');
fprintf('Git Hash: %s \n', git_hash_string);


%% OFF smooth

number =[1936 1937 2014 3048 3903 3908 4113 4981 5013 5522  6110 6529 7054 7461 7462];
number =[1936 2011 3166 3901 4113 4981 5012 6526 7051 7456];

sta = zeros(320,640);
figure;
for i = 1:length(number)
    ref_size = zeros(size(sta));
    hold on 
    load(['/Volumes/Lab/Users/crhoades/Jitter/2016-02-17-6/data026_spikes/Cell ', num2str(number(i)), '.mat'])
    temp = permute(temp, [2,1,3,4]);
    [sig_stixels, params, rf_strength_out] = significant_stixels(temp, 'select', 'thresh', 'thresh', 3.5);

    sig_stixels = full(sig_stixels);
    sig_stixels = sig_stixels(10:end-10, 10:end-10);
biggestBlob_stixs = ExtractNLargestBlobs(sig_stixels, 1);

    ref_size(10:end-10, 10:end-10) = biggestBlob_stixs;
%           plot_sta_(temp)
%      title({'2016-02-17-6 data026' ;['Cell ', num2str(number(i))]})
%     axis off
    sta((ref_size) == 1) = i;
%     sta = sta+ ref_size;

end


figure; imagesc(sta(10:end-10, 10:end-10));

axis image


[~,git_hash_string] = system('git rev-parse HEAD');
fprintf('Git Hash: %s \n', git_hash_string);


%% Mosiac from Vision
dataparam.date='2016-02-17-6';
dataparam.concatname='data025';
dataparam.file_name = [dataparam.date, '/', dataparam.concatname,'/', dataparam.concatname];
select_cells = 1;
if select_cells == 1
%     dataparam.cell_specification = [1936 1937  1938 1940 2012 3048 3903 3906 3907 3908 4114 4116 4981 4983 5013 5523 6111 6528 7055 7462];
number =[1936 1937 2014 3048 3903 3908 4113 4981 5013 5522  6110 6529 7054 7461 7462];

end
dataparam.cell_type = {'all'};

% Right Movie
datarun.names.rrs_neurons_path=['/Volumes/Analysis/', dataparam.file_name, '.neurons'];
datarun.names.rrs_params_path=['/Volumes/Analysis/', dataparam.file_name, '.params'];
datarun.names.rrs_sta_path = ['/Volumes/Analysis/', dataparam.file_name, '.sta'];

opt=struct('verbose',1,'load_params',1,'load_neurons',1,'load_obvius_sta_fits',true, 'load_sta', 1, 'load_sta_params', 1, 'load_all',true);
opt.load_sta_params.save_rf = 1;
% opt.load_sta_params.frames = 1:fitparam.num_frames;% have to input as a vector list of frames, not the number of frames total, counting backwards
datarun=load_data(datarun,opt);

cell_ids = get_cell_indices(datarun, dataparam.cell_specification)
clear sta
summary = zeros(20,40);

for i = 1:length(cell_ids)
sta = double(datarun.stas.stas{cell_ids(i)});

  [sig_stixels, params, rf_strength_out] = significant_stixels(sta, 'select', 'thresh', 'thresh', 4);

    summary = summary+ sig_stixels;

end
    figure; imagesc(summary);
    axis image
    
    [~,git_hash_string] = system('git rev-parse HEAD');
fprintf('Git Hash: %s \n', git_hash_string);

