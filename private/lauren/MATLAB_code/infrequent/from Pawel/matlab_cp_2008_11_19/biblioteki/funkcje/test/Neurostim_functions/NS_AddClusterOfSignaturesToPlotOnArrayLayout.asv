function y=NS_AddClusterOfSignaturesToPlotOnArrayLayout(Traces,Channels,WaveformTypes,ArrayID,FigureProperties,NS_GlobalConstants);
% NIE SKONCZONE !!!!! 2008/03/09
%OffsetCancellation - may have three values:
%a) if 0, the trace is plotted directly;
%b) if 1, then the mean value of the whole trace is subtracted before
%plotting;
%c) if 2, then the mean value of all the samples Deined in the OffsetSamples
%array is subtracted before plotting (for examples, if one wants to plot a spike or
%artifact tha stats 20 samples after beginning of each trace, it may be
%reasonable to use the first milisecond to calculate the DC offset).
STraces=size(Traces);
if STraces(2)~=length(Channels)
    error('The size of Traces array does not match length of Channels array');
end

%Channels=find(Channels~=9);

Fs=NS_GlobalConstants.SamplingFrequency;

FigureNumber=FigureProperties.FigureNumber;
TimeRange=FigureProperties.TimeRange;
AmplitudeRange=FigureProperties.AmplitudeRange;
FontSize=FigureProperties.FontSize;
Colors=FigureProperties.Colors;
LineWidth=FigureProperties.LineWidth;

FontSize=10;

NumberOfTraces=STraces(1);
NumberOfChannels=STraces(2);
TraceLength=STraces(3);

Xstep=60; 
Ystep=60;
electrodeMap=edu.ucsc.neurobiology.vision.electrodemap.ElectrodeMapFactory.getElectrodeMap(ArrayID);
TimeRange=TimeRange./Fs*1000;

%t=[TimeRange(1):(1/Fs*1000):TimeRange(2)];
t=([0:STraces(3)-1])*1000/Fs;

Coordinates=zeros(2,length(Channels));
ChannelsNumber=length(Channels);
for i=1:ChannelsNumber
    Coordinates(1,i)=electrodeMap.getXPosition(Channels(i));
    Coordinates(2,i)=electrodeMap.getYPosition(Channels(i));
end

X0=min(Coordinates(1,:));
X1=max(Coordinates(1,:));
Y0=min(Coordinates(2,:));
Y1=max(Coordinates(2,:));

a=find(Coordinates(2,:)==Y0);
z=10000;
for i=1:length(a)
    if Coordinates(1,a(i))<z
        z=Coordinates(1,a(i));
        SE=a(i);
    end
end

Xspread=X1-X0+Xstep*1.5; %1.5 !!
Yspread=Y1-Y0+Ystep*1.5;

figure(FigureNumber);
clf;

for i=1:NumberOfChannels
    X=(Coordinates(1,i)-X0)/Xspread+0.15; %0.05;
    Y=(Coordinates(2,i)-Y0)/Yspread+0.1; %0.1;
    XSize=Xstep/Xspread;
    YSize=Ystep/Yspread;
    subplot('Position',[X Y XSize*0.9 YSize*0.75]);
    Data=reshape(Traces(:,i,:),NumberOfTraces,TraceLength);
    size(Data);
    h=plot(Data');
    %h=text(2.2,150,num2str(Channels(i)));
    grid on;
    h=gca;
    set(h,'YLim',AmplitudeRange);
    if i==SE
        set(h,'FontSize',FontSize);                
        h=xlabel('time [ms]');
        set(h,'FontSize',FontSize);
        h=ylabel('output signal [mV]');
        set(h,'FontSize',FontSize);
    else
        set(h,'FontSize',FontSize);                
        set(h,'YTickLabel',[]);
        h=xlabel(num2str(Channels(i)));
        %set(h,'FontSize',FontSize);
    end   
    %end
end

y=Data;