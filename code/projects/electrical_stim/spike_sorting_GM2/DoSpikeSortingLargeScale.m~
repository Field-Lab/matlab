function [Output]=DoSpikeSortingLargeScale(pathToPreparation,pathToEi,patternNo,neuronIds,params,varargin)


Dif1=params.global.Dif1;
Dif2=params.global.Dif2;
positions=params.global.positions;
x=params.arrayInfo.x;
useStimElec = params.global.useStimElec;
useBundle = params.bundle.useBundle;

Tmax=params.global.Tmax;
nTrials=params.global.nTrials;

 

if(nargin==6)
   FoldersInd=varargin{1}; 
else
    
    
     
    dirs=dir(pathToPreparation);
    cont=1;
    
    for i=1:length(dirs)
    if(length(dirs(i).name)>=4)
        aux=find(dirs(i).name(1:4)=='data');
    if(length(aux)>0)
        
        FoldersInd(cont)=str2num(dirs(i).name(5:end));
        cont=cont+1;
    
    end
    end
    end
  
end

for f=1:length(FoldersInd)
    pathAux=[pathToPreparation 'data00' num2str(FoldersInd(f))];
        dirs=dir(pathAux);
        
        
        
        for i=1:length(dirs)
        
        aux=find(dirs(i).name(1)=='p');
        if(length(aux)>0)
            
            if(isequal(dirs(i).name(2:end),num2str(patternNo)))
                path=pathAux;
            end
        end
        end
end

pathToAnalysisData=path;




[theta,rho] = cart2pol(positions(:,1)-positions(patternNo,1),positions(:,2)-positions(patternNo,2));


ind=setdiff([1:512],find(rho==0));

rho=rho(ind);

[TracesAll Art var0 listAmps listCurrents onset onsetC pval]=loadTracesArt(pathToAnalysisData,patternNo,Tmax,nTrials,params);


for j=1:length(listAmps)
for i=1:length(listAmps)
Dif3(i,j)=abs(listAmps(i)-listAmps(j));
end
end
Difs{2}=Dif2(ind,ind)/max(max(Dif2(ind,ind)));
Difs{3}=Dif3;
Difs{3}=Difs{3}/max(max(Difs{3}));
Dif1=Dif1/(max(max(Dif1)));
Difs{1}=Dif1;   

Diags{1}=[1:Tmax]'/Tmax;
Diags{2}=rho/max(rho);
Diags{3}=listAmps'/max(listAmps);
     
factp=[0 3 6 9];

for k=1:3
[Ker KerD]=evalKernels(Difs{k},Diags{k},x(factp(k)+1:factp(k+1)),[1 1 1]);
[a b]=eig(Ker);
Q{k}=a';
Qt{k}=a;
dL{k}=diag(b);
Kers{k}=Ker;
end



params.patternInfo.Q=Q;
params.patternInfo.Qt=Qt;
params.patternInfo.Kers=Kers;
params.patternInfo.dL=dL;
params.patternInfo.ind=ind;
params.patternInfo.Art =Art;
params.patternInfo.var0=var0;
params.patternInfo.rho=rho;
params.patternInfo.patternNo=patternNo;

templates=makeTemplatesFromEiShift(pathToEi, neuronIds,[1:512]);
params.neuronInfo.templates = templates;
if(~useStimElec&&(~useBundle))
[spikes Log params]=SpikeSortingNoBundleNoStim(params,TracesAll);
elseif(~useStimElec&&(useBundle))
[spikes Log params]=SpikeSortingBundleNoStim(params,TracesAll);    
end

if(useStimElec)
    Output.stimInfo.ActiveElectrodes=[1:512];
else
    Output.stimInfo.ActiveElectrodes=ind;
end


Output.neuronInfo=params.neuronInfo;
Output.neuronInfo.neuronIds=neuronIds;
Output.neuronInfo.spikes=spikes;

Output.stimInfo.patternNo=patternNo;
Output.stimInfo.listAmps=listAmps;
Output.stimInfo.listCurrents=listCurrents;
Output.stimInfo.Art=params.patternInfo.Art;
Output.stimInfo.nTrials=params.patternInfo.nTrials;
Output.stimInfo.Kers=params.patternInfo.Kers;
Output.stimInfo.rho=rho;
Output.Log=Log;
Output.path.pathToEi=pathToEi;
Output.path.pathToPreparation=pathToPreparation;
Output.path.pathToAnalysisData=pathToAnalysisData;
end

