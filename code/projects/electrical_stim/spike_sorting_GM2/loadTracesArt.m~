function [TracesAll Art var0 listAmps listCurrents onset onsetC]=loadTracesArt(pathToAnalysisData,patternNo,Tmax,nTrials,varargin)
%load data from a pattern in a given folder
%also loads stimulus data and construct a firt artifact estimate (means
%accross trials). nTrials is the maximum number of trials
findBundle=0;

if(nargin==5)
    params=varargin{1};
    Tmax=params.global.Tmax;
    nTrials=params.global.nTrials;
    findBundle=params.bundle.findBundle;
    findBundleTimes=params.bundle.findBundleTimes;
    nNeighborsExclude=params.bundle.nNeighborsExclude;
    detectThreshold= params.bundle.detectThreshold;

end

movieNos  = findMovieNos(pathToAnalysisData,patternNo);
movieNos  = sort(movieNos);



TracesAll=NaN*zeros(length(movieNos),nTrials,512,Tmax);


for m=1:length(movieNos);
    
    dataTraces = NS_ReadPreprocessedData([pathToAnalysisData], '', 0, patternNo,...
        movieNos(m), 99999);
    
    [amps channelsWithStim stimAmpVectors channelsConnected elecCurrentStep currentRangesUsed] = ...
        getStimAmps(pathToAnalysisData, patternNo, movieNos(m));
    
    listAmps(m)=abs(amps(1));
    listCurrents(m,:)=currentRangesUsed(1);
    if(m==1)
        firstArt=mean(dataTraces(:,:,1:Tmax),1);
        
        
    end
    
    TracesAll(m,1:size(dataTraces,1),:,:)=dataTraces(:,:,1:Tmax)-repmat(firstArt,size(dataTraces,1),1,1);
    TracesAll2(m,1:size(dataTraces,1),:,:)=dataTraces(:,:,1:Tmax);
    
    a=TracesAll(m,:,setdiff([1:512],patternNo),:);
    varm(m)=nanvar(a(:));
    Art(m,:,:)=squeeze(nanmean(TracesAll(m,:,:,:)));
   
   
end
var0=nanmean(varm(1:5));

if(findBundle)

[Res]=ResidualsElectrodeSimple(Art,patternNo,findBundleTimes);




    
    
pats=getNeighbors(patternNo,nNeighborsExclude);

for k=1:size(Art,1)
    
[h p]=kstest((log(Res(k,setdiff([1:512],pats)))-nanmean(log(Res(k,setdiff([1:512],pats)))))./nanstd((log(Res(k,setdiff([1:512],pats))))));

pval(k)=log(p);
end
  
    pp(:,1)=NaN;
   
for k=1:length(thresHolds)

    for i=1:length(pattern)
  
    aux=find(pp(i,:)>thresHolds(k));
    comp=lastConnectedComponent(aux);
    
    if(isempty(aux));
      onset(i,k)=listamps{i}(2);
    onsetC(i,k)=2;
    continue
    else
    if(length(comp)==1&&comp(end)==tamr(i))
        if(aux(1)==2)
        onset(i,k)=NaN;
        onsetC(i,k)=NaN;
        continue
        else
            condi=2;
        end
    elseif(length(comp)==1&&comp(end)<tamr(i));
        condi=comp(end)+1;
    else
    if(comp(end)==tamr(i))
        condi=comp(end-1)+1;
    else
        condi=comp(end)+1;
    end
    end
    
    onset(i,k)=listamps{i}(condi);
    onsetC(i,k)=condi;
    end
end

end

pval=pp;


    
    